# پیشنهادات بهبود پروژه FeedbanCur

این سند بر اساس بررسی کد، ساختار و تنظیمات پروژه تهیه شده است.

---

## ۱. امنیت (Security)

### ۱.۱ رمز عبور پیش‌فرض
- **مشکل:** در `app/api/users/route.ts` وقتی رمز ارسال نمی‌شود از `"123456"` استفاده می‌شود.
- **پیشنهاد:** رمز پیش‌فرض را از متغیر محیطی بخوانید (مثلاً `DEFAULT_USER_PASSWORD`) یا اصلاً اجازه ایجاد کاربر بدون رمز ندهید و در UI اجباری کنید. در production حتماً مقدار قوی و یکتا تنظیم شود.

### ۱.۲ CORS بیش از حد باز
- **مشکل:** در `next.config.js` مقدار `Access-Control-Allow-Origin: '*'` برای همه مسیرها ست شده که در production ریسک دارد.
- **پیشنهاد:** در production فقط دامنه‌های مجاز را بگذارید یا این هدرها را فقط برای مسیرهای API که واقعاً به CORS نیاز دارند (مثلاً درخواست از دامنه دیگر) اعمال کنید.

### ۱.۳ حذف تنظیمات منسوخ eslint از next.config
- **مشکل:** Next.js 16 گزینه `eslint` را در config قبول نمی‌کند و هشدار می‌دهد.
- **پیشنهاد:** بلوک `eslint: { ignoreDuringBuilds: true }` را از `next.config.js` حذف کنید و به‌جای آن خطاهای ESLint را برطرف کنید یا از روش پیشنهادی Next.js برای غیرفعال کردن در build استفاده کنید.

### ۱.۴ Rate Limiting روی API
- **مشکل:** روی APIها (مثل لاگین، OTP، ثبت فیدبک عمومی) محدودیت نرخ (rate limit) دیده نشد.
- **پیشنهاد:** برای مسیرهای حساس (مثل `/api/auth`, `/api/otp/send`, `/api/public/`) rate limiting اضافه کنید تا از brute-force و سوءاستفاده جلوگیری شود (مثلاً با `@upstash/ratelimit` یا middleware ساده با Redis/in-memory).

### ۱.۵ اعتبارسنجی و تزریق
- **وضعیت:** استفاده از Zod در بسیاری از APIها خوب است.
- **پیشنهاد:** همه endpointهایی که ورودی کاربر می‌گیرند (به‌خصوص مسیرهای عمومی مثل `/api/public/projects/[token]/feedback`) حتماً با schema مشخص اعتبارسنجی شوند و طول و نوع فیلدها محدود باشد.

---

## ۲. کیفیت کد و TypeScript

### ۲.۱ غیرفعال بودن خطای TypeScript در build
- **مشکل:** در `next.config.js` مقدار `typescript.ignoreBuildErrors: true` باعث می‌شود خطاهای تایپ در build نادیده گرفته شوند.
- **پیشنهاد:** در یک فاز جداگانه خطاهای TypeScript را با `npx tsc --noEmit` برطرف کنید و سپس `ignoreBuildErrors` را `false` کنید تا از نوع‌امن بودن کد اطمینان داشته باشید.

### ۲.۲ استفاده از `any`
- **مشکل:** در چند جا از `any` استفاده شده (مثلاً `where: any` در feedback route، `(user as any).statusId` در auth).
- **پیشنهاد:** تایپ‌های دقیق Prisma یا اینترفیسهای مشترک تعریف کنید و به‌تدریج `any` را حذف کنید.

### ۲.۳ تابع/ماژول مشترک برای احراز هویت API
- **مشکل:** در هر route به‌صورت دستی `getServerSession` و بررسی نقش تکرار شده است.
- **پیشنهاد:** یک helper در `lib/` بسازید، مثلاً:
  - `requireSession()` → session یا 401
  - `requireAdmin()` → session با نقش ADMIN یا 403
  - `requireManagerOrAdmin()` → session با MANAGER/ADMIN یا 403  
  و در routeها از همین توابع استفاده کنید تا کد تمیزتر و یکدست‌تر شود.

---

## ۳. معماری و ساختار

### ۳.۱ لایه سرویس (Service Layer)
- **وضعیت:** منطق کسب‌وکار گاهی مستقیم در routeها نوشته شده (مثلاً ایجاد فیدبک + نوتیفیکیشن در یک route).
- **پیشنهاد:** برای حوزه‌های اصلی (مثلاً feedback، user، notification) سرویس جدا تعریف کنید و از routeها فقط فراخوانی کنید. تست و استفاده مجدد راحت‌تر می‌شود.

### ۳.۲ پاسخ‌های API یکدست
- **مشکل:** بعضی APIها `{ data, pagination }` برمی‌گردانند، بعضی فقط آرایه، و پیام خطاها گاهی فارسی گاهی انگلیسی.
- **پیشنهاد:** یک فرمت استاندارد برای پاسخ موفق (`{ data?, pagination?, message? }`) و خطا (`{ error, code?, details? }`) تعریف کنید و در همه routeها استفاده کنید.

### ۳.۳ مدیریت خطا در API
- **وضعیت:** در catchها گاهی `error.message` یا `error?.code` به کلاینت برگردانده می‌شود.
- **پیشنهاد:** در production جزئیات خطا (مثل stack یا پیام داخلی) را به کاربر نشان ندهید؛ فقط یک کد یا پیام کلی برگردانید و جزئیات را فقط لاگ کنید.

---

## ۴. عملکرد (Performance)

### ۴.۱ Session و دیتابیس
- **مشکل:** در callback مربوط به session در `lib/auth.ts` برای هر درخواست یک بار به دیتابیس برای گرفتن avatar و اطلاعات کاربر زده می‌شود.
- **پیشنهاد:** در صورت امکان avatar را در JWT نگه ندارید (الان هم این کار را کرده‌اید) و فقط وقتی واقعاً لازم است (مثلاً در layout یا یک API مشخص) از DB بخوانید تا بار دیتابیس کم شود.

### ۴.۲ Prisma و N+1
- **وضعیت:** در `app/api/feedback/route.ts` با `Promise.all` و یک query جدا برای managers از N+1 جلوگیری شده که خوب است.
- **پیشنهاد:** در بقیه APIهایی که لیست با relation برمی‌گردانند هم الگوی مشابه (select لازم + یک یا دو query کمکی به‌جای N بار) را رعایت کنید.

### ۴.۳ کش و SWR
- **وضعیت:** استفاده از SWR و `useCachedFetch` مناسب است.
- **پیشنهاد:** برای APIهای سنگین یا کم‌تغییر (مثلاً لیست دپارتمان‌ها، تنظیمات) revalidate و cache strategy را یکدست و شفاف کنید.

---

## ۵. تست (Testing)

### ۵.۱ نبود تست خودکار
- **مشکل:** هیچ فایل `*.test.ts` یا `*.spec.ts` در پروژه نیست.
- **پیشنهاد:** حداقل برای موارد زیر تست بنویسید:
  - توابع کمکی و خالص در `lib/` (مثلاً validation، فرمت‌دهی)
  - APIهای حیاتی (مثلاً ایجاد فیدبک، احراز هویت، نقش‌ها) با یک فریمورک مثل Vitest یا Jest و در صورت نیاز MSW برای mock کردن API.

---

## ۶. لاگ و مانیتورینگ

### ۶.۱ استفاده زیاد از console
- **مشکل:** تعداد زیاد `console.log` / `console.error` در کد production.
- **پیشنهاد:** یک ماژول لاگ ساده (مثلاً `lib/logger.ts`) داشته باشید که در development به console بنویسد و در production به سرویس لاگ یا خاموش باشد. به‌تدریج `console.*` را با آن جایگزین کنید.

---

## ۷. تنظیمات و DevOps

### ۷.۱ next.config و Turbopack
- **مشکل:** Next.js به خاطر چند lockfile (یکی در پروژه و یکی در دایرکتوری بالاتر) هشدار می‌دهد.
- **پیشنهاد:** در `next.config.js` در صورت نیاز `turbopack.root` را روی مسیر پروژه تنظیم کنید یا lockfile اضافی را حذف/جابجا کنید.

### ۷.۲ فایل .env.example
- **وضعیت:** وجود دارد و مفید است.
- **پیشنهاد:** همه متغیرهای ضروری (مثل `NEXTAUTH_SECRET`, `DATABASE_URL`, `OTP_*`) را در `.env.example` با مقدار نمونه یا توضیح کوتاه قرار دهید تا توسعه‌دهنده جدید راحت‌تر محیط را راه بیندازد.

### ۷.۳ پوشه backups در .gitignore
- **وضعیت:** `/backups/` در gitignore است که درست است.
- **پیشنهاد:** در README یا یک سند عملیات توضیح دهید بک‌آپ کجا ذخیره می‌شود و چطور می‌توان آن را به‌صورت امن نگه داشت (مثلاً خارج از repo).

---

## ۸. دسترسی و UX

### ۸.۱ پیام خطا برای کاربر غیرفعال
- **وضعیت:** در `lib/auth.ts` برای کاربر غیرفعال یک `throw new Error(...)` با پیام فارسی وجود دارد که خوب است.
- **پیشنهاد:** مطمئن شوید این خطا در صفحه لاگین به‌صورت خوانا به کاربر نشان داده می‌شود (مثلاً از طریق callback یا صفحه خطای NextAuth).

### ۸.۲ رمز عبور اجباری در اولین ورود
- **وضعیت:** `mustChangePassword` در session و JWT هست و منطق آن در auth در نظر گرفته شده.
- **پیشنهاد:** در UI بعد از لاگین، اگر `mustChangePassword` بود کاربر را حتماً به صفحه تغییر رمز هدایت کنید و تا تغییر رمز اجازه استفاده از بقیه اپ را ندهید.

---

## خلاصه اولویت‌ها

| اولویت | مورد |
|--------|------|
| بالا | رمز پیش‌فرض و CORS در production، حذف eslint از next.config |
| بالا | helper مشترک برای session/نقش در APIها |
| متوسط | رفع خطاهای TypeScript و خاموش کردن ignoreBuildErrors |
| متوسط | Rate limiting برای auth و OTP و APIهای عمومی |
| متوسط | فرمت یکسان پاسخ/خطای API و عدم لو دادن جزئیات خطا در production |
| پایین | تست واحد و یک لایه سرویس برای حوزه‌های اصلی |
| پایین | ماژول لاگ و کاهش console در کد production |

اگر بخواهید می‌توانیم از یکی از این موارد (مثلاً helper احراز هویت یا اصلاح next.config) به‌صورت قدم‌به‌قدم شروع کنیم.
