// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum FeedbackStatus {
  PENDING
  REVIEWED
  ARCHIVED
  DEFERRED    // رسیدگی آینده
  COMPLETED   // انجام شد
}


enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FORWARDED
}

enum PollType {
  SINGLE_CHOICE      // چندگزینه‌ای تک‌انتخابی
  MULTIPLE_CHOICE    // چندگزینه‌ای چندانتخابی
  RATING_SCALE       // مقیاس امتیازدهی (1-5 یا 1-10)
  TEXT_INPUT         // متن آزاد کوتاه
}

enum PollVisibilityMode {
  ANONYMOUS          // رای‌ها مخفی
  PUBLIC             // رای‌ها قابل مشاهده
}

model User {
  id            String    @id @default(cuid())
  mobile        String    @unique
  email         String?
  name          String
  password      String
  avatar        String?   // تصویر پروفایل
  role          UserRole  @default(EMPLOYEE)
  isActive      Boolean   @default(true)
  mustChangePassword Boolean @default(false) // تغییر رمز عبور اجباری در اولین ورود
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  feedbacks          Feedback[]
  forwardedFeedbacks Feedback[]       @relation("ForwardedFeedbacks")
  completedFeedbacks Feedback[]       @relation("CompletedFeedbacks")
  assignedTasks      TaskAssignment[]
  createdTasks       Task[]           @relation("TaskCreator")
  announcements          Announcement[]
  announcementMessages   AnnouncementMessage[] @relation("AnnouncementMessageCreator")
  announcementViews      AnnouncementView[] @relation("AnnouncementViews")
  polls                  Poll[]
  pollResponses          PollResponse[]
  sentMessages           Message[]        @relation("MessageSender")
  notifications          Notification[]   @relation("Notifications")

  @@map("users")
}

model Department {
  id                 String    @id @default(cuid())
  name               String    @unique
  description        String?
  keywords           String[]  // کلیدواژه‌ها برای روتینگ خودکار
  managerId          String?   // مدیر بخش
  allowDirectFeedback Boolean   @default(false) // اجازه ارسال مستقیم فیدبک به مدیر
  canCreateAnnouncement Boolean @default(false) // اجازه ایجاد اعلان برای مدیر بخش
  allowedAnnouncementDepartments String[] @default([]) // لیست ID بخش‌هایی که مدیر می‌تواند برای آنها اعلان ایجاد کند
  canCreatePoll           Boolean  @default(false) // اجازه ایجاد نظرسنجی برای مدیر بخش
  allowedPollDepartments  String[] @default([]) // لیست ID بخش‌هایی که مدیر می‌تواند برای آنها نظرسنجی ایجاد کند
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  users         User[]
  feedbacks     Feedback[]
  tasks         Task[]
  employees     Employee[]
  announcements Announcement[]
  polls         Poll[]

  @@map("departments")
}

model Feedback {
  id             String         @id @default(cuid())
  title          String
  content        String
  image          String?        // URL یا path تصویر ضمیمه شده
  rating         Int?           // 1-5 rating (optional) - deprecated
  type           String         @default("SUGGESTION")
  status         FeedbackStatus @default(PENDING)
  isAnonymous    Boolean        @default(false)
  departmentId   String
  department     Department     @relation(fields: [departmentId], references: [id])
  userId         String
  user           User           @relation(fields: [userId], references: [id])

  // Forwarding fields
  forwardedToId  String?
  forwardedTo    User?          @relation("ForwardedFeedbacks", fields: [forwardedToId], references: [id])
  forwardedAt    DateTime?

  // Completion fields
  completedById  String?
  completedBy    User?          @relation("CompletedFeedbacks", fields: [completedById], references: [id])
  completedAt    DateTime?
  userResponse   String?        // پاسخ به کاربر هنگام تکمیل

  // Archive fields
  adminNotes     String?        // یادداشت‌های ادمین
  managerNotes   String?        // یادداشت‌های مدیر

  // Delete fields
  deletedAt      DateTime?      // تاریخ حذف (soft delete)

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  task           Task?
  checklistItems ChecklistItem[]
  messages       Message[]
  notifications  Notification[]      @relation("FeedbackNotifications")

  @@map("feedbacks")
}

model ChecklistItem {
  id          String   @id @default(cuid())
  feedbackId  String
  feedback    Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  title       String
  isCompleted Boolean  @default(false)
  order       Int      @default(0) // ترتیب نمایش
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("checklist_items")
}

model Employee {
  id           String    @id @default(cuid())
  name         String
  position     String?   // سمت
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  taskAssignments TaskAssignment[]

  @@map("employees")
}

model Task {
  id            String      @id @default(cuid())
  title         String
  description   String
  status        TaskStatus  @default(PENDING)
  priority      String?     // HIGH, MEDIUM, LOW
  isPublic      Boolean     @default(false) // نمایش در بورد عمومی
  completedAt   DateTime?
  feedbackId    String?     @unique
  feedback      Feedback?   @relation(fields: [feedbackId], references: [id])
  departmentId  String
  department    Department  @relation(fields: [departmentId], references: [id])
  createdById   String
  createdBy     User        @relation("TaskCreator", fields: [createdById], references: [id])
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  assignedTo    TaskAssignment[]
  comments      TaskComment[]

  @@map("tasks")
}

model TaskAssignment {
  id         String   @id @default(cuid())
  taskId     String
  task       Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  assignedAt DateTime @default(now())

  @@unique([taskId, employeeId])
  @@unique([taskId, userId])
  @@map("task_assignments")
}

model TaskComment {
  id        String   @id @default(cuid())
  content   String
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@map("task_comments")
}

model Announcement {
  id           String      @id @default(cuid())
  title        String
  content      String
  priority     String?     // HIGH, MEDIUM, LOW
  isActive     Boolean     @default(true) // وضعیت فعال/غیرفعال
  scheduledAt  DateTime?   // زمان انتشار برنامه‌ریزی شده
  publishedAt  DateTime?   // زمان انتشار واقعی
  departmentId String?     // null = برای همه
  department   Department? @relation(fields: [departmentId], references: [id])
  createdById  String
  createdBy    User        @relation(fields: [createdById], references: [id])
  attachments  Json?       // Array of {url: string, name: string} برای فایل‌های ضمیمه
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  messages     AnnouncementMessage[]
  views        AnnouncementView[]

  @@map("announcements")
}

model AnnouncementView {
  id             String       @id @default(cuid())
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation("AnnouncementViews", fields: [userId], references: [id], onDelete: Cascade)
  viewedAt       DateTime     @default(now())

  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
  @@map("announcement_views")
}

model AnnouncementMessage {
  id             String       @id @default(cuid())
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  content        String
  createdById    String
  createdBy      User         @relation("AnnouncementMessageCreator", fields: [createdById], references: [id])
  attachments    Json?        // Array of {url: string, name: string} برای فایل‌های ضمیمه
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([announcementId])
  @@map("announcement_messages")
}

model OTP {
  id        String   @id @default(cuid())
  mobile    String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([mobile])
  @@map("otps")
}

model Message {
  id          String   @id @default(cuid())
  feedbackId  String
  feedback    Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  senderId    String
  sender      User     @relation("MessageSender", fields: [senderId], references: [id])
  content     String
  image       String?  // URL یا path تصویر ضمیمه شده
  isRead      Boolean  @default(false)
  readAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([feedbackId])
  @@index([senderId])
  @@map("messages")
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("Notifications", fields: [userId], references: [id], onDelete: Cascade)
  feedbackId  String?
  feedback    Feedback? @relation("FeedbackNotifications", fields: [feedbackId], references: [id], onDelete: Cascade)
  title       String
  content     String
  type        String   @default("INFO") // INFO, SUCCESS, WARNING, ERROR
  isRead      Boolean  @default(false)
  readAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([isRead])
  @@index([feedbackId])
  @@map("notifications")
}

model Settings {
  id                 String    @id @default(cuid())
  siteName           String
  siteDescription    String?
  language           String    @default("fa")
  timezone           String    @default("Asia/Tehran")
  logoUrl            String?
  emailNotifications Boolean   @default(true)
  smsNotifications   Boolean   @default(false)
  pushNotifications  Boolean   @default(true)
  requirePasswordChange Boolean @default(false)
  sessionTimeout     Int       @default(30)
  twoFactorAuth      Boolean   @default(false)
  allowAnonymous     Boolean   @default(true)
  autoArchiveDays    Int       @default(90)
  maxFeedbackLength  Int       @default(5000)
  itemsPerPage       Int       @default(20)
  theme              String    @default("light")
  statusTexts        Json?     // Store customizable status texts as JSON
  feedbackTypes      Json?     // Store customizable feedback types as JSON array: [{key: string, label: string}]
  notificationSettings Json?   // Store notification preferences as JSON: {directFeedbackToManager: boolean, feedbackCompletedByManager: boolean, ...}
  chatSettings       Json?     // Store chat settings as JSON: {maxFileSize: number (in MB), allowedFileTypes: string[]}
  objectStorageSettings Json?   // Store object storage settings (Liara S3-compatible) as JSON: {enabled: boolean, endpoint: string, accessKeyId: string, secretAccessKey: string, bucket: string, region: string}
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@map("settings")
}

model Poll {
  id                String              @id @default(cuid())
  title             String
  description       String?
  type              PollType            @default(SINGLE_CHOICE)
  visibilityMode    PollVisibilityMode  @default(PUBLIC)
  isActive          Boolean             @default(true)
  allowMultipleVotes Boolean            @default(false)

  // الزامات جدید
  isRequired        Boolean             @default(false)  // اجباری بودن شرکت
  showResultsMode   String              @default("LIVE") // "LIVE" یا "AFTER_CLOSE" - نمایش نتایج
  maxTextLength     Int?                // حداکثر طول متن (برای TEXT_INPUT)

  // زمان‌بندی (مشابه Announcement)
  scheduledAt       DateTime?           // زمان انتشار برنامه‌ریزی شده
  publishedAt       DateTime?           // زمان انتشار واقعی
  closedAt          DateTime?           // زمان بسته شدن

  // هدف‌گیری بخش (null = کل شرکت)
  departmentId      String?
  department        Department?         @relation(fields: [departmentId], references: [id])

  // سازنده
  createdById       String
  createdBy         User                @relation(fields: [createdById], references: [id])

  // برای نظرسنجی امتیازی
  minRating         Int?                // حداقل امتیاز (مثلاً 1)
  maxRating         Int?                // حداکثر امتیاز (مثلاً 5 یا 10)

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // روابط
  options           PollOption[]
  responses         PollResponse[]

  @@map("polls")
}

model PollOption {
  id          String         @id @default(cuid())
  pollId      String
  poll        Poll           @relation(fields: [pollId], references: [id], onDelete: Cascade)
  text        String         // متن گزینه
  order       Int            @default(0)  // ترتیب نمایش
  createdAt   DateTime       @default(now())

  responses   PollResponse[]

  @@index([pollId])
  @@map("poll_options")
}

model PollResponse {
  id          String       @id @default(cuid())
  pollId      String
  poll        Poll         @relation(fields: [pollId], references: [id], onDelete: Cascade)
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // برای نظرسنجی‌های تک/چند گزینه‌ای
  optionId    String?
  option      PollOption?  @relation(fields: [optionId], references: [id], onDelete: Cascade)

  // برای نظرسنجی امتیازی
  ratingValue Int?

  // برای نظرسنجی متن آزاد
  textValue   String?

  // نظر اختیاری
  comment     String?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([pollId])
  @@index([userId])
  @@index([optionId])
  @@map("poll_responses")
}

